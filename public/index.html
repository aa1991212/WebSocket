<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>主持端控制面板</title>
<link rel="stylesheet" href="style.css">
<script src="/socket.io/socket.io.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
</head>
<body>

<div id="bgContainer">
  <video id="bgVideo" autoplay loop muted class="bg-media">
    <source src="bg.mp4" type="video/mp4">
  </video>
  <img id="bgImage" src="bg.jpg" class="bg-media" style="display:none;">
</div>

<div id="danmakuContainer"></div>

<div id="controls">
  <h3>主持人控制面板</h3>

  <div>
    <label>彈幕速度：</label>
    <input type="range" id="speed" min="1" max="10">
    <span id="speedLabel"></span>
  </div>

  <div>
    <label>彈幕密度：</label>
    <input type="range" id="density" min="1" max="10">
    <span id="densityLabel"></span>
  </div>

  <div>
    <label>背景:</label>
    <select id="bgSelect">
      <option value="video">影片</option>
      <option value="image">圖片</option>
    </select>
  </div>

  <div>
    <input type="text" id="newBannedWord" placeholder="新增禁詞">
    <button id="addBannedBtn">新增禁詞</button>
  </div>

  <div>
    <h4>觀眾端 QR Code</h4>
    <canvas id="qrcode"></canvas>
  </div>
</div>

<script>
const socket = io();
const container = document.getElementById('danmakuContainer');
const speedSlider = document.getElementById('speed');
const densitySlider = document.getElementById('density');
const speedLabel = document.getElementById('speedLabel');
const densityLabel = document.getElementById('densityLabel');
const bgSelect = document.getElementById('bgSelect');
const bgVideo = document.getElementById('bgVideo');
const bgImage = document.getElementById('bgImage');
const bannedList = [];
const addBannedBtn = document.getElementById('addBannedBtn');
const newBannedWordInput = document.getElementById('newBannedWord');

let settings = {};
let bannedWords = [];

socket.on('updateSettings', data => {
  settings = data.settings;
  bannedWords = data.bannedWords;

  speedSlider.value = settings.barrageSpeed;
  densitySlider.value = settings.barrageDensity;
  speedLabel.innerText = settings.barrageSpeed;
  densityLabel.innerText = settings.barrageDensity;
  bgSelect.value = settings.backgroundType;

  if(settings.backgroundType==='video'){
    bgVideo.style.display='block';
    bgImage.style.display='none';
  }else{
    bgVideo.style.display='none';
    bgImage.style.display='block';
  }

  // QR Code 指向觀眾端
  // QR Code 指向指定觀眾端網址
const url = 'https://websocket-62f5.onrender.com/input.html';
QRCode.toCanvas(document.getElementById('qrcode'), url, { width: 128 });

});

// 控制面板事件
speedSlider.oninput = () => {
  speedLabel.innerText = speedSlider.value;
  socket.emit('updateSettings', {barrageSpeed: parseInt(speedSlider.value)});
};
densitySlider.oninput = () => {
  densityLabel.innerText = densitySlider.value;
  socket.emit('updateSettings', {barrageDensity: parseInt(densitySlider.value)});
};
bgSelect.onchange = () => {
  socket.emit('updateSettings', {backgroundType:bgSelect.value});
};
addBannedBtn.onclick = () => {
  const word = newBannedWordInput.value.trim();
  if(word) socket.emit('addBannedWord', word);
  newBannedWordInput.value = '';
};

// 顯示彈幕
socket.on('receiveDanmaku', msg => {
  createDanmaku(msg);
});

function createDanmaku(msg){
  const div = document.createElement('div');
  div.className = 'danmaku';
  div.innerText = msg;
  div.style.top = (Math.random()*20+10)+'%';
  div.style.left = -div.offsetWidth+'px';
  container.appendChild(div);
  let speedValue = settings.barrageSpeed + 1;
  function animate(){
    let currentX = parseFloat(div.style.left);
    div.style.left = currentX + speedValue + 'px';
    if(currentX<window.innerWidth){
      requestAnimationFrame(animate);
    }else{
      div.remove();
    }
  }
  requestAnimationFrame(animate);
}
</script>
</body>
</html>

